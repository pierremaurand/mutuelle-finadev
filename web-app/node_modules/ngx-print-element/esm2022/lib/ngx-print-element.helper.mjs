const defaultOptions = {
    htmlType: 'domObj',
    printMode: 'template',
    pageTitle: '',
    templateString: '',
    popupProperties: '',
    stylesheets: [],
    styles: [],
    baseHref: ''
};
/**
 * HEAD Element
 * @returns
 */
const HEAD = () => {
    const head = document.getElementsByTagName('head')[0];
    const ID = (Math.round(Math.random() * 9999999)).toString();
    const nameUID = `ngx-print-element-${ID}`;
    const nameUIDHead = `ngx-print-element-head-${ID}`;
    const nameUIDBody = `ngx-print-element-body-${ID}`;
    const nameUIDIFrame = `ngx-print-element-iframe-${ID}`;
    return { head, nameUID, nameUIDHead, nameUIDBody, nameUIDIFrame };
};
/**
 * ADD_STYLE_HEAD
 * @param _H
 */
const ADD_STYLE_HEAD = (_H) => {
    const style = document.createElement('style');
    style.innerHTML = BUILD_STYLE(_H);
    style.id = `${_H.nameUIDHead}`;
    _H.head.appendChild(style);
};
/**
 * BUILD_STYLE
 * @param _H
 * @returns
 */
const BUILD_STYLE = (_H) => {
    return `
  @media print {
    .${_H.nameUIDBody} {
      visibility: hidden !important;
    }
    .${_H.nameUID},
    .${_H.nameUID} * {
        visibility: visible !important;
    }
    .${_H.nameUID} {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
    }
    .${_H.nameUID} .print-none {
        display: none !important;
    }
    /* ----- Author: DaiDH ----- */
    /* Copyright (C) 2022 - ${new Date().getFullYear()} */
  }`;
};
/**
 * REMOVE_STYLE_HEAD
 * @param _H
 */
const REMOVE_STYLE_HEAD = (_H) => {
    const styleToRemove = document.getElementById(_H.nameUIDHead);
    if (styleToRemove) {
        _H.head.removeChild(styleToRemove);
    }
};
/**
 * getBaseHref
 * @param options
 * @returns
 */
export const getBaseHref = (options) => {
    const port = (window.location.port) ? `:${window.location.port}` : '';
    const buildURL = `${window.location.protocol}//${window.location.hostname}${port}${window.location.pathname}`;
    const finalURL = options.baseHref ? options.baseHref : buildURL;
    return finalURL;
};
/**
 * getMarkup
 * print-html-element
 * @param element
 * @param options
 * @param _H
 * @returns
 */
export const getMarkup = (element, options, _H) => {
    const template = options.templateString;
    const templateRegex = new RegExp(/{{\s*printBody\s*}}/gi);
    let stylesheets;
    let styles;
    const html = [];
    if (options.htmlType === 'domObj') {
        element = element.outerHTML;
    }
    if (options.htmlType === 'text') {
        element = element.innerText;
    }
    if (template && templateRegex.test(template)) {
        element = template.replace(templateRegex, element);
    }
    html.push(`<html><head><title>${options.pageTitle || ''}</title>`);
    // If stylesheet URL's or list of stylesheet URL's are specified, override page stylesheets
    if (options.stylesheets) {
        stylesheets = Array.isArray(options.stylesheets) ? options.stylesheets : [options.stylesheets];
    }
    else {
        stylesheets = Array.prototype.slice
            .call(document.getElementsByTagName('link'))
            .map(link => link);
    }
    stylesheets.forEach((f) => {
        html.push(`<link rel="${f.rel}" href="${f.href}">`);
    });
    // If inline styles or list of inline styles are specified, override inline styles
    if (options.styles) {
        styles = Array.isArray(options.styles) ? [...options.styles, BUILD_STYLE(_H)] : [options.styles + BUILD_STYLE(_H)];
    }
    else {
        styles = Array.prototype.slice
            .call(document.getElementsByTagName('style'))
            .map(style => style.innerHTML);
    }
    styles.forEach((style) => {
        html.push(`<style type="text/css">${style}</style>`);
    });
    html.push(`<base href="${getBaseHref(options)}"/>`);
    html.push(`</head><body class="${_H.nameUID}">`);
    html.push(element);
    html.push('</body></html>');
    return html.join('');
};
/**
 * Print window.open
 * @param element
 * @param selfOptions
 * @param as
 */
export const printElementWindow = (element, selfOptions = {}, as) => {
    try {
        const options = { ...defaultOptions, ...selfOptions };
        const container = element.nativeElement;
        const _H = HEAD();
        // New window
        const printWindow = window.open('about:blank', 'printElementWindow', options.popupProperties);
        const printDocument = printWindow && printWindow.document;
        // Get markup to be printed
        const markup = getMarkup(container, options, _H);
        ADD_STYLE_HEAD(_H);
        // Close
        const onPrintFinished = (printed) => {
            printDocument.close();
            printWindow.close();
            REMOVE_STYLE_HEAD(_H);
            AS_COMPLETE(as, { close: true });
        };
        // Print
        printWindow.focus();
        printDocument.write(markup);
        setTimeout(() => onPrintFinished(printWindow.print()), selfOptions && selfOptions.windowOpenTimeout || 500);
        printWindow.onbeforeprint = (event) => AS_COMPLETE(as, event);
        printWindow.onafterprint = (event) => AS_COMPLETE(as, event);
    }
    catch (error) {
        AS_COMPLETE(as, error);
    }
};
/**
 * Print iFrame
 * @param element
 * @param selfOptions
 * @param as
 */
export const printIFrame = (element, selfOptions = {}, as) => {
    try {
        // Declare
        const options = { ...defaultOptions, ...selfOptions };
        const container = element.nativeElement;
        const _H = HEAD();
        // Get markup to be printed
        const markup = getMarkup(container, options, _H);
        // Create iframe
        let iframe = document.createElement('iframe');
        iframe.setAttribute('id', _H.nameUIDIFrame);
        iframe.setAttribute('class', _H.nameUIDIFrame);
        iframe.setAttribute('src', 'about:blank');
        iframe.setAttribute('frameBorder', '0');
        iframe.setAttribute('scrolling', 'no');
        iframe.setAttribute('style', 'position:fixed;bottom:100%;right:100%;');
        document.body.appendChild(iframe);
        let iDocument = null;
        if (iframe.contentDocument) {
            iDocument = iframe.contentDocument;
        }
        else if (iframe.contentWindow) {
            iDocument = iframe.contentWindow.document;
        }
        ADD_STYLE_HEAD(_H);
        // SetTimeout fixesiframe printMode does not work in firefox
        setTimeout(() => {
            // Close
            const onPrintFinished = (printed) => {
                iDocument.close();
                REMOVE_STYLE_HEAD(_H);
                iframe.remove();
                AS_COMPLETE(as, { close: true });
            };
            // Print
            iframe.contentWindow.focus();
            iDocument.open();
            iDocument.write(markup);
            setTimeout(() => onPrintFinished(iframe.contentWindow.print()), selfOptions && selfOptions.windowOpenTimeout || 200);
            iframe.contentWindow.onbeforeprint = (event) => AS_COMPLETE(as, event);
            iframe.contentWindow.onafterprint = (event) => AS_COMPLETE(as, event);
        });
    }
    catch (error) {
        AS_COMPLETE(as, error);
    }
};
/**
 * Print default
 * @param element
 * @param renderer
 * @param as
 */
export const printDefault = (element, renderer, selfOptions = {}, as) => {
    try {
        // Declare
        const container = element.nativeElement;
        const _H = HEAD();
        // Add visibility hidden into body
        const bodyEls = Array.from(document.querySelectorAll('body'));
        if (bodyEls.length) {
            bodyEls.forEach((f) => f && f.classList.add(_H.nameUIDBody));
            renderer.addClass(container, _H.nameUID);
            ADD_STYLE_HEAD(_H);
        }
        // Close
        const onPrintFinished = (printed) => {
            // Clear visibility: hidden
            bodyEls.forEach((f) => f && f.classList.remove(_H.nameUIDBody));
            renderer.setAttribute(container, 'class', container.className.replace(_H.nameUID, ''));
            REMOVE_STYLE_HEAD(_H);
            AS_COMPLETE(as, { close: true });
        };
        // Print
        window.focus();
        setTimeout(() => onPrintFinished(window.print()), selfOptions && selfOptions.windowOpenTimeout || 0);
        window.onbeforeprint = (event) => AS_COMPLETE(as, event);
        window.onafterprint = (event) => AS_COMPLETE(as, event);
    }
    catch (error) {
        AS_COMPLETE(as, error);
    }
};
/**
 * Rxjs complete
 * @param as
 * @param data
 * @param error
 */
export const AS_COMPLETE = (as, data, error = null) => {
    error ? as.error(error) : as.next(data);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXByaW50LWVsZW1lbnQuaGVscGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXByaW50LWVsZW1lbnQvc3JjL2xpYi9uZ3gtcHJpbnQtZWxlbWVudC5oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsTUFBTSxjQUFjLEdBQVc7SUFDN0IsUUFBUSxFQUFFLFFBQVE7SUFDbEIsU0FBUyxFQUFFLFVBQVU7SUFDckIsU0FBUyxFQUFFLEVBQUU7SUFDYixjQUFjLEVBQUUsRUFBRTtJQUNsQixlQUFlLEVBQUUsRUFBRTtJQUNuQixXQUFXLEVBQUUsRUFBRTtJQUNmLE1BQU0sRUFBRSxFQUFFO0lBQ1YsUUFBUSxFQUFFLEVBQUU7Q0FDYixDQUFDO0FBV0Y7OztHQUdHO0FBQ0gsTUFBTSxJQUFJLEdBQUcsR0FBTyxFQUFFO0lBQ3BCLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RCxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDNUQsTUFBTSxPQUFPLEdBQUcscUJBQXFCLEVBQUUsRUFBRSxDQUFDO0lBQzFDLE1BQU0sV0FBVyxHQUFHLDBCQUEwQixFQUFFLEVBQUUsQ0FBQztJQUNuRCxNQUFNLFdBQVcsR0FBRywwQkFBMEIsRUFBRSxFQUFFLENBQUM7SUFDbkQsTUFBTSxhQUFhLEdBQUcsNEJBQTRCLEVBQUUsRUFBRSxDQUFDO0lBQ3ZELE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLENBQUM7QUFDcEUsQ0FBQyxDQUFBO0FBRUQ7OztHQUdHO0FBQ0gsTUFBTSxjQUFjLEdBQUcsQ0FBQyxFQUFNLEVBQUUs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RSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxXQUFXLElBQUksV0FBVyxDQUFDLGlCQUFpQixJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3JHLE1BQU0sQ0FBQyxhQUFhLEdBQUcsQ0FBQyxLQUFVLEVBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDOUQsTUFBTSxDQUFDLFlBQVksR0FBRyxDQUFDLEtBQVUsRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLFdBQVcsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekIsQ0FBQztBQUNILENBQUMsQ0FBQTtBQUdEOzs7OztHQUtHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLENBQUMsRUFBZ0IsRUFBRSxJQUFTLEVBQUUsS0FBSyxHQUFHLElBQUksRUFBRSxFQUFFO0lBQ3ZFLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbGVtZW50UmVmLCBSZW5kZXJlcjIgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSBcIi4vbmd4LXByaW50LWVsZW1lbnQuc2VydmljZVwiO1xyXG5cclxuY29uc3QgZGVmYXVsdE9wdGlvbnM6IENvbmZpZyA9IHtcclxuICBodG1sVHlwZTogJ2RvbU9iaicsXHJcbiAgcHJpbnRNb2RlOiAndGVtcGxhdGUnLFxyXG4gIHBhZ2VUaXRsZTogJycsXHJcbiAgdGVtcGxhdGVTdHJpbmc6ICcnLFxyXG4gIHBvcHVwUHJvcGVydGllczogJycsXHJcbiAgc3R5bGVzaGVldHM6IFtdLFxyXG4gIHN0eWxlczogW10sXHJcbiAgYmFzZUhyZWY6ICcnXHJcbn07XHJcblxyXG5cclxuaW50ZXJmYWNlIF9IIHtcclxuICBoZWFkOiBIVE1MSGVhZEVsZW1lbnQ7XHJcbiAgbmFtZVVJRDogc3RyaW5nO1xyXG4gIG5hbWVVSURIZWFkOiBzdHJpbmc7XHJcbiAgbmFtZVVJREJvZHk6IHN0cmluZztcclxuICBuYW1lVUlESUZyYW1lOiBzdHJpbmc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBIRUFEIEVsZW1lbnRcclxuICogQHJldHVybnMgXHJcbiAqL1xyXG5jb25zdCBIRUFEID0gKCk6IF9IID0+IHtcclxuICBjb25zdCBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXTtcclxuICBjb25zdCBJRCA9IChNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiA5OTk5OTk5KSkudG9TdHJpbmcoKTtcclxuICBjb25zdCBuYW1lVUlEID0gYG5neC1wcmludC1lbGVtZW50LSR7SUR9YDtcclxuICBjb25zdCBuYW1lVUlESGVhZCA9IGBuZ3gtcHJpbnQtZWxlbWVudC1oZWFkLSR7SUR9YDtcclxuICBjb25zdCBuYW1lVUlEQm9keSA9IGBuZ3gtcHJpbnQtZWxlbWVudC1ib2R5LSR7SUR9YDtcclxuICBjb25zdCBuYW1lVUlESUZyYW1lID0gYG5neC1wcmludC1lbGVtZW50LWlmcmFtZS0ke0lEfWA7XHJcbiAgcmV0dXJuIHsgaGVhZCwgbmFtZVVJRCwgbmFtZVVJREhlYWQsIG5hbWVVSURCb2R5LCBuYW1lVUlESUZyYW1lIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBRERfU1RZTEVfSEVBRFxyXG4gKiBAcGFyYW0gX0ggXHJcbiAqL1xyXG5jb25zdCBBRERfU1RZTEVfSEVBRCA9IChfSDogX0gpID0+IHtcclxuICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XHJcbiAgc3R5bGUuaW5uZXJIVE1MID0gQlVJTERfU1RZTEUoX0gpO1xyXG4gIHN0eWxlLmlkID0gYCR7X0gubmFtZVVJREhlYWR9YDtcclxuICBfSC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEJVSUxEX1NUWUxFXHJcbiAqIEBwYXJhbSBfSCBcclxuICogQHJldHVybnMgXHJcbiAqL1xyXG5jb25zdCBCVUlMRF9TVFlMRSA9IChfSDogX0gpOiBzdHJpbmcgPT4ge1xyXG4gIHJldHVybiBgXHJcbiAgQG1lZGlhIHByaW50IHtcclxuICAgIC4ke19ILm5hbWVVSURCb2R5fSB7XHJcbiAgICAgIHZpc2liaWxpdHk6IGhpZGRlbiAhaW1wb3J0YW50O1xyXG4gICAgfVxyXG4gICAgLiR7X0gubmFtZVVJRH0sXHJcbiAgICAuJHtfSC5uYW1lVUlEfSAqIHtcclxuICAgICAgICB2aXNpYmlsaXR5OiB2aXNpYmxlICFpbXBvcnRhbnQ7XHJcbiAgICB9XHJcbiAgICAuJHtfSC5uYW1lVUlEfSB7XHJcbiAgICAgICAgcG9zaXRpb246IGFic29sdXRlICFpbXBvcnRhbnQ7XHJcbiAgICAgICAgbGVmdDogMCAhaW1wb3J0YW50O1xyXG4gICAgICAgIHRvcDogMCAhaW1wb3J0YW50O1xyXG4gICAgfVxyXG4gICAgLiR7X0gubmFtZVVJRH0gLnByaW50LW5vbmUge1xyXG4gICAgICAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDtcclxuICAgIH1cclxuICAgIC8qIC0tLS0tIEF1dGhvcjogRGFpREggLS0tLS0gKi9cclxuICAgIC8qIENvcHlyaWdodCAoQykgMjAyMiAtICR7bmV3IERhdGUoKS5nZXRGdWxsWWVhcigpfSAqL1xyXG4gIH1gXHJcbn07XHJcblxyXG4vKipcclxuICogUkVNT1ZFX1NUWUxFX0hFQURcclxuICogQHBhcmFtIF9IIFxyXG4gKi9cclxuY29uc3QgUkVNT1ZFX1NUWUxFX0hFQUQgPSAoX0g6IF9IKSA9PiB7XHJcbiAgY29uc3Qgc3R5bGVUb1JlbW92ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKF9ILm5hbWVVSURIZWFkKTtcclxuICBpZiAoc3R5bGVUb1JlbW92ZSkge1xyXG4gICAgX0guaGVhZC5yZW1vdmVDaGlsZChzdHlsZVRvUmVtb3ZlKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBnZXRCYXNlSHJlZlxyXG4gKiBAcGFyYW0gb3B0aW9ucyBcclxuICogQHJldHVybnMgXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgZ2V0QmFzZUhyZWYgPSAob3B0aW9uczogQ29uZmlnKSA9PiB7XHJcbiAgY29uc3QgcG9ydCA9ICh3aW5kb3cubG9jYXRpb24ucG9ydCkgPyBgOiR7d2luZG93LmxvY2F0aW9uLnBvcnR9YCA6ICcnO1xyXG4gIGNvbnN0IGJ1aWxkVVJMID0gYCR7d2luZG93LmxvY2F0aW9uLnByb3RvY29sfS8vJHt3aW5kb3cubG9jYXRpb24uaG9zdG5hbWV9JHtwb3J0fSR7d2luZG93LmxvY2F0aW9uLnBhdGhuYW1lfWA7XHJcbiAgY29uc3QgZmluYWxVUkwgPSBvcHRpb25zLmJhc2VIcmVmID8gb3B0aW9ucy5iYXNlSHJlZiA6IGJ1aWxkVVJMO1xyXG4gIHJldHVybiBmaW5hbFVSTDtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBnZXRNYXJrdXBcclxuICogcHJpbnQtaHRtbC1lbGVtZW50XHJcbiAqIEBwYXJhbSBlbGVtZW50IFxyXG4gKiBAcGFyYW0gb3B0aW9ucyBcclxuICogQHBhcmFtIF9IIFxyXG4gKiBAcmV0dXJucyBcclxuICovXHJcbmV4cG9ydCBjb25zdCBnZXRNYXJrdXAgPSAoZWxlbWVudDogYW55LCBvcHRpb25zOiBDb25maWcsIF9IOiBfSCkgPT4ge1xyXG4gIGNvbnN0IHRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZVN0cmluZztcclxuICBjb25zdCB0ZW1wbGF0ZVJlZ2V4ID0gbmV3IFJlZ0V4cCgve3tcXHMqcHJpbnRCb2R5XFxzKn19L2dpKTtcclxuICBsZXQgc3R5bGVzaGVldHM7XHJcbiAgbGV0IHN0eWxlcztcclxuICBjb25zdCBodG1sID0gW107XHJcblxyXG4gIGlmIChvcHRpb25zLmh0bWxUeXBlID09PSAnZG9tT2JqJykge1xyXG4gICAgZWxlbWVudCA9IGVsZW1lbnQub3V0ZXJIVE1MO1xyXG4gIH1cclxuXHJcbiAgaWYgKG9wdGlvbnMuaHRtbFR5cGUgPT09ICd0ZXh0Jykge1xyXG4gICAgZWxlbWVudCA9IGVsZW1lbnQuaW5uZXJUZXh0O1xyXG4gIH1cclxuXHJcbiAgaWYgKHRlbXBsYXRlICYmIHRlbXBsYXRlUmVnZXgudGVzdCh0ZW1wbGF0ZSkpIHtcclxuICAgIGVsZW1lbnQgPSB0ZW1wbGF0ZS5yZXBsYWNlKHRlbXBsYXRlUmVnZXgsIGVsZW1lbnQpO1xyXG4gIH1cclxuXHJcbiAgaHRtbC5wdXNoKGA8aHRtbD48aGVhZD48dGl0bGU+JHtvcHRpb25zLnBhZ2VUaXRsZSB8fCAnJ308L3RpdGxlPmApO1xyXG5cclxuICAvLyBJZiBzdHlsZXNoZWV0IFVSTCdzIG9yIGxpc3Qgb2Ygc3R5bGVzaGVldCBVUkwncyBhcmUgc3BlY2lmaWVkLCBvdmVycmlkZSBwYWdlIHN0eWxlc2hlZXRzXHJcbiAgaWYgKG9wdGlvbnMuc3R5bGVzaGVldHMpIHtcclxuICAgIHN0eWxlc2hlZXRzID0gQXJyYXkuaXNBcnJheShvcHRpb25zLnN0eWxlc2hlZXRzKSA/IG9wdGlvbnMuc3R5bGVzaGVldHMgOiBbb3B0aW9ucy5zdHlsZXNoZWV0c107XHJcbiAgfSBlbHNlIHtcclxuICAgIHN0eWxlc2hlZXRzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlXHJcbiAgICAgIC5jYWxsKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdsaW5rJykpXHJcbiAgICAgIC5tYXAobGluayA9PiBsaW5rKTtcclxuICB9XHJcblxyXG4gIHN0eWxlc2hlZXRzLmZvckVhY2goKGY6IGFueSkgPT4ge1xyXG4gICAgaHRtbC5wdXNoKGA8bGluayByZWw9XCIke2YucmVsfVwiIGhyZWY9XCIke2YuaHJlZn1cIj5gKTtcclxuICB9KTtcclxuXHJcbiAgLy8gSWYgaW5saW5lIHN0eWxlcyBvciBsaXN0IG9mIGlubGluZSBzdHlsZXMgYXJlIHNwZWNpZmllZCwgb3ZlcnJpZGUgaW5saW5lIHN0eWxlc1xyXG4gIGlmIChvcHRpb25zLnN0eWxlcykge1xyXG4gICAgc3R5bGVzID0gQXJyYXkuaXNBcnJheShvcHRpb25zLnN0eWxlcykgPyBbLi4ub3B0aW9ucy5zdHlsZXMsIEJVSUxEX1NUWUxFKF9IKV0gOiBbb3B0aW9ucy5zdHlsZXMgKyBCVUlMRF9TVFlMRShfSCldO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBzdHlsZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2VcclxuICAgICAgLmNhbGwoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3N0eWxlJykpXHJcbiAgICAgIC5tYXAoc3R5bGUgPT4gc3R5bGUuaW5uZXJIVE1MKTtcclxuICB9XHJcblxyXG4gIHN0eWxlcy5mb3JFYWNoKChzdHlsZTogYW55KSA9PiB7XHJcbiAgICBodG1sLnB1c2goYDxzdHlsZSB0eXBlPVwidGV4dC9jc3NcIj4ke3N0eWxlfTwvc3R5bGU+YCk7XHJcbiAgfSk7XHJcblxyXG4gIGh0bWwucHVzaChgPGJhc2UgaHJlZj1cIiR7Z2V0QmFzZUhyZWYob3B0aW9ucyl9XCIvPmApO1xyXG4gIGh0bWwucHVzaChgPC9oZWFkPjxib2R5IGNsYXNzPVwiJHtfSC5uYW1lVUlEfVwiPmApO1xyXG4gIGh0bWwucHVzaChlbGVtZW50KTtcclxuICBodG1sLnB1c2goJzwvYm9keT48L2h0bWw+Jyk7XHJcblxyXG4gIHJldHVybiBodG1sLmpvaW4oJycpO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIFByaW50IHdpbmRvdy5vcGVuXHJcbiAqIEBwYXJhbSBlbGVtZW50IFxyXG4gKiBAcGFyYW0gc2VsZk9wdGlvbnMgXHJcbiAqIEBwYXJhbSBhcyBcclxuICovXHJcbmV4cG9ydCBjb25zdCBwcmludEVsZW1lbnRXaW5kb3cgPSAoZWxlbWVudDogRWxlbWVudFJlZjxhbnk+LCBzZWxmT3B0aW9uczogQ29uZmlnID0ge30sIGFzOiBTdWJqZWN0PGFueT4pID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHsgLi4uZGVmYXVsdE9wdGlvbnMsIC4uLnNlbGZPcHRpb25zIH07XHJcbiAgICBjb25zdCBjb250YWluZXIgPSBlbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICBjb25zdCBfSCA9IEhFQUQoKTtcclxuXHJcbiAgICAvLyBOZXcgd2luZG93XHJcbiAgICBjb25zdCBwcmludFdpbmRvdyA9IHdpbmRvdy5vcGVuKCdhYm91dDpibGFuaycsICdwcmludEVsZW1lbnRXaW5kb3cnLCBvcHRpb25zLnBvcHVwUHJvcGVydGllcykgYXMgYW55O1xyXG4gICAgY29uc3QgcHJpbnREb2N1bWVudCA9IHByaW50V2luZG93ICYmIHByaW50V2luZG93LmRvY3VtZW50IGFzIGFueTtcclxuXHJcbiAgICAvLyBHZXQgbWFya3VwIHRvIGJlIHByaW50ZWRcclxuICAgIGNvbnN0IG1hcmt1cCA9IGdldE1hcmt1cChjb250YWluZXIsIG9wdGlvbnMsIF9IKTtcclxuXHJcbiAgICBBRERfU1RZTEVfSEVBRChfSCk7XHJcblxyXG4gICAgLy8gQ2xvc2VcclxuICAgIGNvbnN0IG9uUHJpbnRGaW5pc2hlZCA9IChwcmludGVkOiBhbnkpID0+IHtcclxuICAgICAgcHJpbnREb2N1bWVudC5jbG9zZSgpO1xyXG4gICAgICBwcmludFdpbmRvdy5jbG9zZSgpO1xyXG4gICAgICBSRU1PVkVfU1RZTEVfSEVBRChfSCk7XHJcbiAgICAgIEFTX0NPTVBMRVRFKGFzLCB7IGNsb3NlOiB0cnVlIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyBQcmludFxyXG4gICAgcHJpbnRXaW5kb3cuZm9jdXMoKTtcclxuICAgIHByaW50RG9jdW1lbnQud3JpdGUobWFya3VwKTtcclxuICAgIHNldFRpbWVvdXQoKCkgPT4gb25QcmludEZpbmlzaGVkKHByaW50V2luZG93LnByaW50KCkpLCBzZWxmT3B0aW9ucyAmJiBzZWxmT3B0aW9ucy53aW5kb3dPcGVuVGltZW91dCB8fCA1MDApO1xyXG4gICAgcHJpbnRXaW5kb3cub25iZWZvcmVwcmludCA9IChldmVudDogYW55KSA9PiBBU19DT01QTEVURShhcywgZXZlbnQpO1xyXG4gICAgcHJpbnRXaW5kb3cub25hZnRlcnByaW50ID0gKGV2ZW50OiBhbnkpID0+IEFTX0NPTVBMRVRFKGFzLCBldmVudCk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIEFTX0NPTVBMRVRFKGFzLCBlcnJvcik7XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIFByaW50IGlGcmFtZVxyXG4gKiBAcGFyYW0gZWxlbWVudCBcclxuICogQHBhcmFtIHNlbGZPcHRpb25zIFxyXG4gKiBAcGFyYW0gYXMgXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgcHJpbnRJRnJhbWUgPSAoZWxlbWVudDogRWxlbWVudFJlZjxhbnk+LCBzZWxmT3B0aW9uczogQ29uZmlnID0ge30sIGFzOiBTdWJqZWN0PGFueT4sKSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIC8vIERlY2xhcmVcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7IC4uLmRlZmF1bHRPcHRpb25zLCAuLi5zZWxmT3B0aW9ucyB9O1xyXG4gICAgY29uc3QgY29udGFpbmVyID0gZWxlbWVudC5uYXRpdmVFbGVtZW50O1xyXG4gICAgY29uc3QgX0ggPSBIRUFEKCk7XHJcblxyXG4gICAgLy8gR2V0IG1hcmt1cCB0byBiZSBwcmludGVkXHJcbiAgICBjb25zdCBtYXJrdXAgPSBnZXRNYXJrdXAoY29udGFpbmVyLCBvcHRpb25zLCBfSCk7XHJcblxyXG4gICAgLy8gQ3JlYXRlIGlmcmFtZVxyXG4gICAgbGV0IGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpIGFzIEhUTUxJRnJhbWVFbGVtZW50IHwgYW55O1xyXG4gICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnaWQnLCBfSC5uYW1lVUlESUZyYW1lKTtcclxuICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgX0gubmFtZVVJRElGcmFtZSk7XHJcbiAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCdzcmMnLCAnYWJvdXQ6YmxhbmsnKTtcclxuICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ2ZyYW1lQm9yZGVyJywgJzAnKTtcclxuICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ3Njcm9sbGluZycsICdubycpO1xyXG4gICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCAncG9zaXRpb246Zml4ZWQ7Ym90dG9tOjEwMCU7cmlnaHQ6MTAwJTsnKTtcclxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTtcclxuXHJcbiAgICBsZXQgaURvY3VtZW50OiBhbnkgPSBudWxsO1xyXG4gICAgaWYgKGlmcmFtZS5jb250ZW50RG9jdW1lbnQpIHtcclxuICAgICAgaURvY3VtZW50ID0gaWZyYW1lLmNvbnRlbnREb2N1bWVudDtcclxuICAgIH0gZWxzZSBpZiAoaWZyYW1lLmNvbnRlbnRXaW5kb3cpIHtcclxuICAgICAgaURvY3VtZW50ID0gaWZyYW1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgQUREX1NUWUxFX0hFQUQoX0gpO1xyXG5cclxuICAgIC8vIFNldFRpbWVvdXQgZml4ZXNpZnJhbWUgcHJpbnRNb2RlIGRvZXMgbm90IHdvcmsgaW4gZmlyZWZveFxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcblxyXG4gICAgICAvLyBDbG9zZVxyXG4gICAgICBjb25zdCBvblByaW50RmluaXNoZWQgPSAocHJpbnRlZDogYW55KSA9PiB7XHJcbiAgICAgICAgaURvY3VtZW50LmNsb3NlKCk7XHJcbiAgICAgICAgUkVNT1ZFX1NUWUxFX0hFQUQoX0gpO1xyXG4gICAgICAgIGlmcmFtZS5yZW1vdmUoKTtcclxuICAgICAgICBBU19DT01QTEVURShhcywgeyBjbG9zZTogdHJ1ZSB9KTtcclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIFByaW50XHJcbiAgICAgIGlmcmFtZS5jb250ZW50V2luZG93LmZvY3VzKCk7XHJcbiAgICAgIGlEb2N1bWVudC5vcGVuKCk7XHJcbiAgICAgIGlEb2N1bWVudC53cml0ZShtYXJrdXApO1xyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IG9uUHJpbnRGaW5pc2hlZChpZnJhbWUuY29udGVudFdpbmRvdy5wcmludCgpKSwgc2VsZk9wdGlvbnMgJiYgc2VsZk9wdGlvbnMud2luZG93T3BlblRpbWVvdXQgfHwgMjAwKTtcclxuICAgICAgaWZyYW1lLmNvbnRlbnRXaW5kb3cub25iZWZvcmVwcmludCA9IChldmVudDogYW55KSA9PiBBU19DT01QTEVURShhcywgZXZlbnQpO1xyXG4gICAgICBpZnJhbWUuY29udGVudFdpbmRvdy5vbmFmdGVycHJpbnQgPSAoZXZlbnQ6IGFueSkgPT4gQVNfQ09NUExFVEUoYXMsIGV2ZW50KTtcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBBU19DT01QTEVURShhcywgZXJyb3IpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFByaW50IGRlZmF1bHRcclxuICogQHBhcmFtIGVsZW1lbnQgXHJcbiAqIEBwYXJhbSByZW5kZXJlciBcclxuICogQHBhcmFtIGFzIFxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IHByaW50RGVmYXVsdCA9IChlbGVtZW50OiBFbGVtZW50UmVmPGFueT4sIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHNlbGZPcHRpb25zOiBDb25maWcgPSB7fSwgYXM6IFN1YmplY3Q8YW55PikgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICAvLyBEZWNsYXJlXHJcbiAgICBjb25zdCBjb250YWluZXIgPSBlbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICBjb25zdCBfSCA9IEhFQUQoKTtcclxuXHJcbiAgICAvLyBBZGQgdmlzaWJpbGl0eSBoaWRkZW4gaW50byBib2R5XHJcbiAgICBjb25zdCBib2R5RWxzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdib2R5JykpO1xyXG4gICAgaWYgKGJvZHlFbHMubGVuZ3RoKSB7XHJcbiAgICAgIGJvZHlFbHMuZm9yRWFjaCgoZjogYW55KSA9PiBmICYmIGYuY2xhc3NMaXN0LmFkZChfSC5uYW1lVUlEQm9keSkpO1xyXG4gICAgICByZW5kZXJlci5hZGRDbGFzcyhjb250YWluZXIsIF9ILm5hbWVVSUQpO1xyXG4gICAgICBBRERfU1RZTEVfSEVBRChfSCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2xvc2VcclxuICAgIGNvbnN0IG9uUHJpbnRGaW5pc2hlZCA9IChwcmludGVkOiBhbnkpID0+IHtcclxuICAgICAgLy8gQ2xlYXIgdmlzaWJpbGl0eTogaGlkZGVuXHJcbiAgICAgIGJvZHlFbHMuZm9yRWFjaCgoZjogYW55KSA9PiBmICYmIGYuY2xhc3NMaXN0LnJlbW92ZShfSC5uYW1lVUlEQm9keSkpO1xyXG4gICAgICByZW5kZXJlci5zZXRBdHRyaWJ1dGUoY29udGFpbmVyLCAnY2xhc3MnLCBjb250YWluZXIuY2xhc3NOYW1lLnJlcGxhY2UoX0gubmFtZVVJRCwgJycpKTtcclxuICAgICAgUkVNT1ZFX1NUWUxFX0hFQUQoX0gpO1xyXG4gICAgICBBU19DT01QTEVURShhcywgeyBjbG9zZTogdHJ1ZSB9KTtcclxuICAgIH07XHJcblxyXG4gICAgLy8gUHJpbnRcclxuICAgIHdpbmRvdy5mb2N1cygpO1xyXG4gICAgc2V0VGltZW91dCgoKSA9PiBvblByaW50RmluaXNoZWQod2luZG93LnByaW50KCkpLCBzZWxmT3B0aW9ucyAmJiBzZWxmT3B0aW9ucy53aW5kb3dPcGVuVGltZW91dCB8fCAwKTtcclxuICAgIHdpbmRvdy5vbmJlZm9yZXByaW50ID0gKGV2ZW50OiBhbnkpID0+IEFTX0NPTVBMRVRFKGFzLCBldmVudCk7XHJcbiAgICB3aW5kb3cub25hZnRlcnByaW50ID0gKGV2ZW50OiBhbnkpID0+IEFTX0NPTVBMRVRFKGFzLCBldmVudCk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIEFTX0NPTVBMRVRFKGFzLCBlcnJvcik7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIFJ4anMgY29tcGxldGVcclxuICogQHBhcmFtIGFzIFxyXG4gKiBAcGFyYW0gZGF0YSBcclxuICogQHBhcmFtIGVycm9yIFxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IEFTX0NPTVBMRVRFID0gKGFzOiBTdWJqZWN0PGFueT4sIGRhdGE6IGFueSwgZXJyb3IgPSBudWxsKSA9PiB7XHJcbiAgZXJyb3IgPyBhcy5lcnJvcihlcnJvcikgOiBhcy5uZXh0KGRhdGEpO1xyXG59O1xyXG4iXX0=